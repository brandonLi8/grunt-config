# Copyright © 2019 Brandon Li. All rights reserved.

#!————————————————————————————————————————————————————————————————————————————*!
# Github action for deploying commits to the production branch to heroku.
#
# Requires the HEROKU_API_TOKEN secret. See
# https://help.heroku.com/PBGP6IDE/how-should-i-generate-an-api-key-that-allows-me-to-use-the-heroku-platform-api to
# generate this token.
#
# IMPORTANT: This file was auto-generated by `grunt generate-deploy-heroku`. It
#            is recommended to not modify this file. For more information, see
#            https://github.com/brandonLi8/grunt-config/.
#
# @author Brandon Li <brandon.li820@gmail.com>
#!————————————————————————————————————————————————————————————————————————————*!
name: deploy                        # tentative workflow name

on:
  push:                             # activate on the push action
    branches:
      - production                  # only activate on the production branch

jobs:
  build:
    name: deploy                    # tentative workflow name
    runs-on: ubuntu-latest

    steps:                          # checkout and set up node
    - uses: actions/checkout@v1     # ensure a fresh checkout of source code

    - name: Setup Node              # setup Node.js
      uses: actions/setup-node@v1
      with:
        node-version: '12.x'

    - name: npm stability           # ensure the stability of npm
      run: |
        npm prune -production=true  # prune for a fresh node_modules directory
        npm cache clean --f         # clear the cache
        npm install                 # install dependencies

    - name: lint                    # ensure all source code is lint-free
      run: grunt eslint --no-cache  # ensure everything is linted

    - name: test                    # ensure that all tests pass
      run: npm test --if-present

    - name: deploy to heroku        # finally deploy to heroku
      env:
        HEROKU_API_TOKEN: ${{ secrets.HEROKU_API_TOKEN }}
        HEROKU_APP_NAME: "@brandonli8/grunt-config"
      if: github.ref == 'refs/heads/production' && job.status == 'success'
      run: git push https://heroku:$HEROKU_API_TOKEN@git.heroku.com/$HEROKU_APP_NAME.git origin/master:master